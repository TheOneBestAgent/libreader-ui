version: '3.8'

services:
  # LibRead Ereader Application
  reader-app:
    build: .
    container_name: libread-reader
    ports:
      - "3001:3001"
    environment:
      - NODE_ENV=production
      - PORT=3001
      - PRONOUNCEX_TTS_API=http://pronouncex-api:8000
      - EDGE_TTS_API=http://edge-tts-api:8001
      - POCKET_TTS_API=http://pocket-tts-api:8002
      - ESPEAK_TTS_API=http://espeak-tts-api:8003
      - ALLOWED_ORIGINS=http://localhost:3001,http://127.0.0.1:3001
    networks:
      - pronouncex-net
    depends_on:
      pronouncex-api:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3001/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # Redis for TTS job queue
  redis:
    image: redis:7-alpine
    container_name: pronouncex-redis
    command: ["redis-server", "--save", "", "--appendonly", "no"]
    networks:
      - pronouncex-net
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 2s
      timeout: 2s
      retries: 30
    restart: unless-stopped

  # PronounceX TTS API
  pronouncex-api:
    build:
      context: ../Projects/Ipa-tts-implementation
      dockerfile: ci/Dockerfile.golden
    container_name: pronouncex-api
    working_dir: /repo/pronouncex-tts
    command: >
      bash -lc "
      uvicorn api.app:app
      --host 0.0.0.0
      --port 8000
      --workers 2
      --log-level info
      "
    environment:
      - PRONOUNCEX_TTS_REDIS_URL=redis://redis:6379/0
      - PRONOUNCEX_TTS_GPU=0
      - PRONOUNCEX_TTS_WORKERS=2
      - PRONOUNCEX_TTS_MAX_CONCURRENT_SEGMENTS=1
      - PRONOUNCEX_TTS_ENGINE=piper
      - PIPER_DEFAULT_VOICE=en_US-amy-medium
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - pronouncex-net
    expose:
      - "8000"
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://127.0.0.1:8000/health >/dev/null"]
      interval: 5s
      timeout: 2s
      retries: 40
    restart: unless-stopped
    volumes:
      - tts-cache:/repo/pronouncex-tts/data/cache
      - tts-dicts:/repo/pronouncex-tts/data/dicts

  # TTS Worker (for processing synthesis jobs)
  tts-worker:
    build:
      context: ../Projects/Ipa-tts-implementation
      dockerfile: ci/Dockerfile.golden
    container_name: pronouncex-worker
    working_dir: /repo/pronouncex-tts
    command: ["bash", "-lc", "python -m core.worker_main"]
    environment:
      - PRONOUNCEX_TTS_REDIS_URL=redis://redis:6379/0
      - PRONOUNCEX_TTS_GPU=0
      - PRONOUNCEX_TTS_ENGINE=piper
      - PIPER_DEFAULT_VOICE=en_US-amy-medium
    depends_on:
      redis:
        condition: service_healthy
      pronouncex-api:
        condition: service_healthy
    networks:
      - pronouncex-net
    restart: unless-stopped
    volumes:
      - tts-cache:/repo/pronouncex-tts/data/cache
      - tts-dicts:/repo/pronouncex-tts/data/dicts

  # Edge-TTS Service (Microsoft voices, no phoneme support)
  edge-tts-api:
    build:
      context: ./edge-tts-service
      dockerfile: Dockerfile
    container_name: edge-tts-api
    environment:
      - EDGE_TTS_REDIS_URL=redis://redis:6379/1
      - EDGE_TTS_DEFAULT_VOICE=en-US-AriaNeural
      - EDGE_TTS_CACHE_DIR=/data/cache
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - pronouncex-net
    expose:
      - "8001"
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://127.0.0.1:8001/health >/dev/null"]
      interval: 5s
      timeout: 2s
      retries: 40
    restart: unless-stopped
    volumes:
      - edge-tts-cache:/data/cache

  # Pocket TTS Service (Voice cloning, ONNX-based, CPU optimized)
  pocket-tts-api:
    build:
      context: ./pocket-tts-api
      dockerfile: Dockerfile
    container_name: pocket-tts-api
    environment:
      - POCKET_TTS_MODEL_DIR=/app/model
      - POCKET_TTS_OUTPUT_DIR=/tmp/pocket-tts
      - POCKET_TTS_VOICES_DIR=/app/voices
      - POCKET_TTS_LSD_STEPS=1
      - POCKET_TTS_TEMPERATURE=0.7
      - PORT=8002
    networks:
      - pronouncex-net
    expose:
      - "8002"
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://127.0.0.1:8002/health >/dev/null"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 180s  # Model download + loading takes time
    restart: unless-stopped
    volumes:
      - pocket-tts-model:/app/model
      - pocket-tts-voices:/app/voices
      - pocket-tts-cache:/tmp/pocket-tts

  # eSpeak-NG TTS Service (Lightweight, offline capable, phoneme support)
  espeak-tts-api:
    build:
      context: ./espeak-tts-service
      dockerfile: Dockerfile
    container_name: espeak-tts-api
    environment:
      - ESPEAK_TTS_REDIS_URL=redis://redis:6379/2
      - ESPEAK_TTS_DEFAULT_VOICE=en-us
      - ESPEAK_TTS_CACHE_DIR=/data/cache
      - ESPEAK_SPEED=175
      - PRONOUNCEX_API_URL=http://pronouncex-api:8000
    depends_on:
      redis:
        condition: service_healthy
      pronouncex-api:
        condition: service_healthy
    networks:
      - pronouncex-net
    expose:
      - "8003"
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://127.0.0.1:8003/health >/dev/null"]
      interval: 5s
      timeout: 2s
      retries: 40
    restart: unless-stopped
    volumes:
      - espeak-tts-cache:/data/cache

networks:
  pronouncex-net:
    driver: bridge

volumes:
  tts-cache:
  tts-dicts:
  edge-tts-cache:
  pocket-tts-model:
  pocket-tts-voices:
  pocket-tts-cache:
  espeak-tts-cache:
